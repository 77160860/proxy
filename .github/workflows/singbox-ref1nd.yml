name: Build Lite sing-box Core
on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: 'Source ref to build (tag/branch/commit)'
        type: string
        required: true
        default: 'reF1nd-main'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Prepare context
        id: prep
        run: |
          UPSTREAM_REPO="https://github.com/reF1nd/sing-box.git"
          REF="${{ github.event.inputs.source_ref }}"
          echo "REF=$REF" >> $GITHUB_ENV
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> $GITHUB_ENV
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "upstream=$UPSTREAM_REPO" >> $GITHUB_OUTPUT
      
      - name: Resolve SHA (tag/branch/commit)
        id: upstream
        run: |
          set -e
          SHA=$(git ls-remote --heads "${UPSTREAM_REPO}" "refs/heads/${REF}" | cut -f1)
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "refs/tags/${REF}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "refs/tags/${REF}^{}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "${UPSTREAM_REPO}" "${REF}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            echo "ERROR: REF '${REF}' not found (branch/tag/commit)."
            exit 1
          fi
          SHORT="${SHA:0:7}"
          echo "UPSTREAM_SHA=$SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT" >> $GITHUB_ENV
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short=$SHORT" >> $GITHUB_OUTPUT
      
      - name: Checkout upstream with full history
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ steps.upstream.outputs.sha }}
          fetch-depth: 0
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true
      
      - name: Extract, Clean, and Prefix Version
        id: extract_version
        run: |
          RAW_VERSION=$(go run ./cmd/internal/read_tag)
          if [ -z "$RAW_VERSION" ]; then
            echo "ERROR: 'go run ./cmd/internal/read_tag' failed to produce a version string."
            exit 1
          fi
          CLEANED_VERSION=$(echo "$RAW_VERSION" | sed 's/-reF1nd$//')
          FINAL_VERSION="r${CLEANED_VERSION}"
          echo "VERSION=$FINAL_VERSION" >> $GITHUB_ENV
          echo "version=$FINAL_VERSION" >> $GITHUB_OUTPUT
      
      - name: Define build metadata
        id: meta
        run: |
          BUILD_TAGS="with_gvisor with_quic with_utls with_acme with_clash_api with_purego badlinkname tfogo_checklinkname0"
          OUT_LINUX_ARM64="sing-box-arm64"
          OUT_LINUX_AMD64="sing-box-amd64"
          
          TAG="singbox"
          
          echo "BUILD_TAGS=$BUILD_TAGS" >> $GITHUB_ENV
          echo "OUT_LINUX_ARM64=$OUT_LINUX_ARM64" >> $GITHUB_ENV
          echo "OUT_LINUX_AMD64=$OUT_LINUX_AMD64" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          
          echo "build_tags=$BUILD_TAGS" >> $GITHUB_OUTPUT
          echo "out_linux_arm64=$OUT_LINUX_ARM64" >> $GITHUB_OUTPUT
          echo "out_linux_amd64=$OUT_LINUX_AMD64" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Build sing-box (linux arm64)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: "0"
        run: |
          go build -trimpath -o "${OUT_LINUX_ARM64}" -ldflags="-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" -tags="${BUILD_TAGS}" ./cmd/sing-box
      
      - name: Build sing-box (linux amd64)
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: "0"
        run: |
          go build -trimpath -o "${OUT_LINUX_AMD64}" -ldflags="-s -w -X github.com/sagernet/sing-box/constant.Version=${VERSION}" -tags="${BUILD_TAGS}" ./cmd/sing-box
      
      - name: Verify arch
        run: |
          ls -lh "${OUT_LINUX_ARM64}" "${OUT_LINUX_AMD64}"
      
      - name: Cleanup old release
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: singbox lite (${{ env.VERSION }})
          body: |
            Source: ${{ env.REF }}
            Version: ${{ env.VERSION }}
            Commit: ${{ steps.upstream.outputs.short }}
            GOOS/GOARCH: linux:arm64/amd64
            Build Tags: ${{ steps.meta.outputs.build_tags }}
            
            *此 Release 为滚动更新，Tag 固定为 singbox*
          prerelease: false
          make_latest: true
          files: |
            ${{ steps.meta.outputs.out_linux_arm64 }}
            ${{ steps.meta.outputs.out_linux_amd64 }}
