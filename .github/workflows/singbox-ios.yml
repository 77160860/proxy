name: Build singbox-ios (reF1nd)

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: 'Source ref to build (tag/branch/commit)'
        type: string
        required: true
        default: 'reF1nd-main'
      prerelease:
        description: '是否发布为测试版? (true/false)'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']
      update_apple:
        description: '是否重新拉取最新 singbox-apple 仓库?'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Prepare context
        id: prep
        run: |
          set -e
          UPSTREAM_REPO="https://github.com/reF1nd/sing-box.git"
          REF="${{ github.event.inputs.source_ref }}"
          echo "UPSTREAM_REPO=$UPSTREAM_REPO" >> "$GITHUB_ENV"
          echo "REF=$REF" >> "$GITHUB_ENV"
          echo "upstream=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Resolve SHA (tag/branch/commit)
        id: upstream
        run: |
          set -e
          SHA=$(git ls-remote --heads "${UPSTREAM_REPO}" "refs/heads/${REF}" | cut -f1)
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "refs/tags/${REF}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote --tags "${UPSTREAM_REPO}" "refs/tags/${REF}^{}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "${UPSTREAM_REPO}" "${REF}" | cut -f1)
          fi
          if [ -z "$SHA" ]; then
            echo "ERROR: REF '${REF}' not found (branch/tag/commit)."
            exit 1
          fi
          SHORT="${SHA:0:7}"
          echo "UPSTREAM_SHA=$SHA" >> "$GITHUB_ENV"
          echo "SHORT_SHA=$SHORT" >> "$GITHUB_ENV"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "short=$SHORT" >> "$GITHUB_OUTPUT"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          check-latest: true

      - name: Setup Xcode stable
        run: |-
          set -e
          sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version >> "$GITHUB_STEP_SUMMARY"

      - name: Install ldid (via brew)
        run: |
          set -e
          brew update
          brew install ldid || brew upgrade ldid

      - name: Clone reF1nd/sing-box and extract version
        id: ref1nd
        run: |
          set -ex

          rm -rf "$HOME/sing-box-ref1nd"
          git clone --recurse-submodules --depth 1 https://github.com/reF1nd/sing-box.git "$HOME/sing-box-ref1nd"
          cd "$HOME/sing-box-ref1nd"

          git fetch --tags --force
          git checkout "${UPSTREAM_SHA}"

          RAW=$(go run ./cmd/internal/read_tag)
          if [ -z "$RAW" ]; then
            echo "ERROR: go run ./cmd/internal/read_tag returned empty."
            exit 1
          fi
          CLEAN=$(echo "$RAW" | sed 's/-reF1nd$//')

          echo "RAW_REF1ND_VERSION=$RAW" >> "$GITHUB_ENV"
          echo "REF1ND_VERSION=$CLEAN" >> "$GITHUB_ENV"

          echo "raw=$RAW" >> "$GITHUB_OUTPUT"
          echo "version=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Build TIPA (reF1nd)
        run: |
          set -ex

          echo "sing-box reF1nd ${REF1ND_VERSION} (raw: ${RAW_REF1ND_VERSION}) @ ${SHORT_SHA}" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ inputs.update_apple }}" = "true" ]; then
            rm -rf "$HOME/sing-box-ref1nd/clients/apple"
            git clone --recurse-submodules --depth 1 https://github.com/SagerNet/sing-box-for-apple.git "$HOME/sing-box-ref1nd/clients/apple"
          fi

          export XCODEPROJ_NAME=sing-box
          export APPLICATION_NAME=sing-box
          export SCHEME_NAME=SFI

          cd "$HOME/sing-box-ref1nd"

          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"
          go run ./cmd/internal/build_libbox -target apple -platform ios
          mv Libbox.xcframework clients/apple

          cd clients/apple

          grep -rl \
            --exclude-dir=.git \
            --exclude-dir=DerivedData \
            --exclude='*.a' \
            --exclude='*.framework' \
            --exclude='*.xcframework' \
            'io.nekohasekai.sfavt' . \
          | xargs perl -0777 -pi -e \
              's/io\.nekohasekai\.sfavt/io.nekohasekai.sfavt-reF1nd/g'

          xcodebuild \
            -project "$XCODEPROJ_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -destination 'generic/platform=iOS' \
            -configuration Debug \
            -sdk iphoneos \
            build install \
            INFOPLIST_KEY_CFBundleDisplayName="${APPLICATION_NAME}-reF1nd" \
            PRODUCT_BUNDLE_IDENTIFIER="io.nekohasekai.sfavt-reF1nd" \
            EXTENSION_PRODUCT_BUNDLE_IDENTIFIER="io.nekohasekai.sfavt-reF1nd.extension" \
            STRIP_INSTALLED_PRODUCT=NO \
            ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=NO \
            ENABLE_BITCODE=NO \
            DSTROOT=packages/

          ldid -SSFI/SFI.entitlements "packages/Applications/$APPLICATION_NAME.app/$APPLICATION_NAME"
          ldid -SExtension/Extension.entitlements "packages/Applications/$APPLICATION_NAME.app/PlugIns/Extension.appex/Extension"
          ldid -SIntentsExtension/IntentsExtension.entitlements "packages/Applications/$APPLICATION_NAME.app/Extensions/IntentsExtension.appex/IntentsExtension"

          mkdir -p packages/Payload
          cp -rp "packages/Applications/$APPLICATION_NAME.app" packages/Payload
          cd packages
          zip -qr "$APPLICATION_NAME.tipa" Payload

          OUT="${GITHUB_WORKSPACE}/${APPLICATION_NAME}-ios-reF1nd-${REF1ND_VERSION}-${SHORT_SHA}.tipa"
          mv "$APPLICATION_NAME.tipa" "$OUT"
          echo -e "SHA256:\n$(shasum -a 256 "$OUT")" >> "$GITHUB_STEP_SUMMARY"

          rm -rf ~/Library/Developer/Xcode/DerivedData
          rm -rf "$HOME/sing-box-ref1nd"

      - name: Compute release tag/name
        id: rel
        run: |
          set -e
          TAG="sing-box-ios-reF1nd-${REF1ND_VERSION}-${SHORT_SHA}"
          NAME="sing-box iOS reF1nd (${REF1ND_VERSION})"
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=$NAME" >> "$GITHUB_ENV"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Create Release and Upload TIPA
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: |
            Source: ${{ env.REF }}
            Version: ${{ env.REF1ND_VERSION }}
            Raw Version: ${{ env.RAW_REF1ND_VERSION }}
            Commit: ${{ env.SHORT_SHA }}
            Upstream: ${{ steps.prep.outputs.upstream }}
          prerelease: ${{ inputs.prerelease == 'true' }}
          files: |
            sing-box-ios-reF1nd-*.tipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
